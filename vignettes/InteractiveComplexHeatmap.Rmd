---
title: "How to visualize heatmaps interactively"
author: "Zuguang Gu ( z.gu@dkfz.de )"
date: "`r Sys.Date()`"
output: 
    rmarkdown::html_vignette:
        width: 8
        fig_width: 5
vignette: >
  %\VignetteIndexEntry{1. How to visualize heatmaps interactively}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r, echo = FALSE}
library(knitr)
knitr::opts_chunk$set(
    error = FALSE,
    tidy  = FALSE,
    message = FALSE,
    warning = FALSE,
    fig.align = "center"
)
```

```{r, eval = FALSE}
suppressPackageStartupMessages(library(InteractiveComplexHeatmap))
```

<style>
p {
    margin: 1em 0;
}
</style>

## Usage

The **InteractiveComplexHeatmap** package is very straightforward to use. For
any heatmap (or list of heatmaps as a `Heatmap` or `HeatmapList` object)
produced from **ComplexHeatmap** package, you just use the function
`ht_shiny()` to export it as a Shiny app.

You can copy and paste the following code:

```{r, eval = FALSE}
library(ComplexHeatmap)
library(InteractiveComplexHeatmap)
m = matrix(rnorm(100*100), nrow = 100)
ht = Heatmap(ht)
ht = draw(ht) # not necessary, but recommended

ht_shiny(ht)
```

A link will be opend in your web browser automatically (or a pop-up window in RStudio IDE).

To use `ht_shiny()`, the `Heatmap`/`HeatmapList` object is not necessary to be
updated with `draw()` and it will be applied inside `ht_shiny()`
automatically. However, updating by `draw()` will speed up the loading of the
Shiny app because `draw()` applies clustering (which is normally the most
time-consuming part) and the clustering results are saved the heatmap object.
If your heatmap includes randomness, such as k-means clustring by setting
`row_km` or `column_km` argument, then you must execute `draw()` before
sending to `ht_shiny()`.


Following screenshot demonstrates the Shiny app on rather complex heatmaps.
The data is from
[here](http://jokergoo.github.io/supplementary/ComplexHeatmap-supplementary1-4/supplS2_scRNASeq/supplS2_scRNAseq.html)
with slightly changing the original code for making heatmaps.

In this Shiny app, users can click on the orignal heatmap or select an area
from it. The information of the position or the area selected by users can be
found in the text below the heatmaps. If an area is selected, a sub-heatmap is
drawn on the right side of the app. Both heatmaps can be resized by dragging
from the bottom right.

<p><img width='100%' style='border:1px solid grey;padding: 4px;' src='https://jokergoo.github.io/images/example3.gif' /></p>

Please note, if the heatmap is too huge or you resize the heatmap too
frequently, the heatmap might not be correctly updated. You can just slightly
resize the heatmap again and wait for several seconds (you might have already observed
from the previous screenshot that the right heatmap was not properly drawn when I first
resized it).

There are three other vignettes focusing on more specific topics:

- [How interactive ComplexHeatmap is implemented](implementation.html)
- [Functions for Shiny app development](shiny_dev.html)
- [Decorations on the heatmaps](decoration.html)


## Live examples

The following code demostrates two horizontally concatenated heatmaps. Please
visit https://jokergoo.shinyapps.io/interactive_complexheatmap/ for a live
demo.

```{r, eval = FALSE}
set.seed(123)
mat1 = matrix(rnorm(100), 10)
rownames(mat1) = colnames(mat1) = paste0("a", 1:10)
mat2 = matrix(sample(letters[1:10], 100, replace = TRUE), 10)
rownames(mat2) = colnames(mat2) = paste0("b", 1:10)

ht_list = Heatmap(mat1, name = "mat_a", row_km = 2, column_km = 2) +
    Heatmap(mat2, name = "mat_b")
ht_shiny(ht_list)
```

The following code demostrates two vertically concatenated heatmaps. Check
https://jokergoo.shinyapps.io/interactive_complexheatmap_vertical/ for a live demo.

```{r, eval = FALSE}
ht_list = Heatmap(mat1, name = "mat_a", row_km = 2, column_km = 2) %v%
    Heatmap(mat2, name = "mat_b")
ht_shiny(ht_list)
```


## Integrate with other plots and packages 

The functionality of the interactivity is general. It can be applied to any
heatmap as long as it is generated from the **ComplexHeatmap** package. Thus,
it can trun many other plots into an interactive app.

### Interactive density heatmap

`ComplexHeatmap::densityHeatmap()` returns a `Heatmap` object, so it can
be exported as a Shiny app. Check
https://jokergoo.shinyapps.io/interactive_densityheatmap/ for a live demo. The
example can also be run locally by executing `ht_shiny_example(12)`. The usage
of `ht_shiny_example()` will be introduced later and in the webpage opened by
`ht_shiny_example()` there is also the source code for generating this Shiny app.

```{r, eval = FALSE}
ht = densityHeatmap(...)
ht_shiny(ht)
```

### Interactive oncoPrint

`ComplexHeatmap::oncoPrint()` returns a `Heatmap` object, thus, the oncoPrint can be interactive.
Example code is as follows. Check https://jokergoo.shinyapps.io/interactive_oncoprint/ for a live demo.
The example can be run locally by executing `ht_shiny_example(7)`.

```{r, eval = FALSE}
ht = oncoPrint(...)
ht_shiny(ht)

ht = oncoPrint(...) + Heatmap(...) + rowAnnotation(...)
ht_shiny(ht)
```

### Interactive UpSet plot

`ComplexHeatmap::UpSet()` returns a `Heatmap` object, thus, the UpSet plot generated by **ComplexHeatmap**
can be interactive. It might be useful when you visualize many sets as the same time. Example code is as follows.
Check https://jokergooo.shinyapps.io/interactive_upset/ for a live demo. The example can be run locally by executing `ht_shiny_example(8)`.

```{r, eval = FALSE}
cm = make_comb_mat(...)
ht = UpSet(cm, ...)
ht_shiny(ht)
```

### Interactive enriched heatmap

[**EnrichedHeatmap**](https://www.bioconductor.org/packages/release/bioc/html/EnrichedHeatmap.html) inherits
**ComplexHeatmap** and it outputs `Heatmap` objects, thus, an "enriched heatmap" can be exported
as a Shiny app as well. Check
https://jokergoo.shinyapps.io/interactive_enrichedheatmap/ for a live demo. The example can be run locally by executing `ht_shiny_example(12)`.

```{r, eval = FALSE}
mat = normalizeToMatrix(...)
ht = EnrichedHeatmap(mat, ...)
ht_shiny(ht)
```

### Interactive pheatmap

Since **ComplexHeatmap** can [seamlessly integrate
**pheatmap**](https://jokergoo.github.io/2020/05/06/translate-from-pheatmap-to-complexheatmap/),
this means your pheatmap can be interactive! Check
https://jokergooo.shinyapps.io/interactive_pheatmap/. The example can be run locally by executing `ht_shiny_example(9)`.

`ComplexHeatmap::pheatmap()` and `pheatmap::pheatmap()` have the same set of
arguments and generate almost the same heatmaps, but be careful when you
directly use `pheatmap()` without the namespace (the package name) prefix, you need
to make sure it is from **ComplexHeatmap** if you want to use the interactive
functionality. 

```{r, eval = FALSE}
ht = pheatmap(...) # ComplexHeatmap::pheatmap should overwrite pheatmap::pheatmap
ht_shiny(ht)
```


### Interactive heatmap

To facilitate the users who are still using `heatmap()` and `heatmap.2()`
functions, to make the output of these two functions can be exported as
interactive Shiny apps as well, from **ComplexHeatmap** version 2.7.2, two
similar translation functions `ComplexHeatmap::heatmap()` and
`ComplexHeatmap::heatmap.2()` which use the same set of arguments as the
original functions and generate almost identical heatmaps. Then an interactive
`heatmap()` will look like:

```{r, eval = FALSE}
ht = heatmap(...) # ComplexHeatmap::heatmap should overwrite stats::heatmap
ht_shiny(ht)
```

An live example is at https://jokergooo.shinyapps.io/interactive_heatmap/. The
example can be run locally by executing `ht_shiny_example(10)`.


### Interactive heatmap.2

Similarly, an interactive `heatmap.2()` looks like:

```{r, eval = FALSE}
ht = heatmap.2(...) # ComplexHeatmap::heatmap.2 should overwrite gplots::heatmap.2
ht_shiny(ht)
```

An live example is at https://jokergooo.shinyapps.io/interactive_heatmap_2/.
The example can be run locally by executing `ht_shiny_example(11)`.


### Interactive tidyHeatmap

[The **tidyHeatmap** package](https://CRAN.R-project.org/package=tidyHeatmap)
basically wraps **ComplexHeatmap** and provides "a tidy way" for generating
heatmaps. Since the final heatmap is actually generated by **ComplexHeatmap**,
it can be directly exported as an interactive app. You can directly apply `ht_shiny()`
on the object generated from **tidyHeatmap**. Check
https://jokergooo.shinyapps.io/interactive_tidyheatmap/. The example can be
run locally by executing `ht_shiny_example(15)`.


```{r, eval = FALSE}
library(tidyverse)
library(tidyHeatmap)
mtcars_tidy <- 
    mtcars %>% 
    as_tibble(rownames="Car name") %>% 
    
    # Scale
    mutate_at(vars(-`Car name`, -hp, -vs), scale) %>%
    
    # tidyfy
    pivot_longer(cols = -c(`Car name`, hp, vs), names_to = "Property", values_to = "Value")

mtcars_heatmap <- 
    mtcars_tidy %>% 
        heatmap(`Car name`, Property, Value ) %>%
        add_tile(hp)

ht_shiny(mtcars_heatmap)
```


## Examples shipped with the package

There are many other examples shipped with the **InteractiveComplexHeatmap**
package. The list of examples can be obtained by executing
`ht_shiny_example()` with no argument.


```{r, eval = FALSE}
ht_shiny_example()
```

And you can select one specific example by sending the corresponding index to
`ht_shiny_example()`, e.g. to run the example "4. A single heatmap where rows
and columns are split.", simply run:

```{r, eval = FALSE}
ht_shiny_example(4)
```

Then the interactive heatmaps as well as the source code for generating the app
will be available in the webpage.

## SessionInfo

```{r}
sessionInfo()
```


```{r, echo = FALSE, results = "hide"}
# to get rid of the BiocCheck warning
invisible(NULL)
```

```{r, echo = FALSE, results = "hide"}
invisible(NULL)
```

```{r, echo = FALSE, results = "hide"}
invisible(NULL)
```

```{r, echo = FALSE, results = "hide"}
invisible(NULL)
```

```{r, echo = FALSE, results = "hide"}
invisible(NULL)
```

```{r, echo = FALSE, results = "hide"}
invisible(NULL)
```

```{r, echo = FALSE, results = "hide"}
invisible(NULL)
```

```{r, echo = FALSE, results = "hide"}
invisible(NULL)
```

```{r, echo = FALSE, results = "hide"}
invisible(NULL)
```

```{r, echo = FALSE, results = "hide"}
invisible(NULL)
```
